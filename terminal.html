<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>粉蓝 CRT 终端</title>
    <style>
        body {
            background: #000000;
            color: #A7C7E7;
            font-family: monospace;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }


        .crt {
            width: 90vw;
            height: 80vh;
            background: #0a0a14;
            color: #89CFF0;
            font-size: 18px;
            line-height: 1.5;
            padding: 20px;
            box-shadow: inset 0 0 30px #1e3a8a;
            border-radius: 10px;
            overflow-y: auto;
            position: relative;
            text-shadow: 0 0 4px #B19CD9, 0 0 8px #FFB6C1;
        }

        .crt:focus {
            outline: none;
            box-shadow: inset 0 0 30px #1e3a8a;
        }


        .cursor {
            display: inline-block;
            width: 10px;
            height: 18px;
            background: #89CFF0;
            margin-left: 2px;
            animation: blink 1s step-start infinite;
        }

        @keyframes blink {
            50% {
                background: transparent;
            }
        }
    </style>
</head>

<body>
    <div class="crt" id="terminal" tabindex="0"></div>

    <script src="terminal-data.js"></script>

    <script>
        const terminal = document.getElementById("terminal");
        let buffer = "";
        let commandCount = 0;

        // === 打字机效果 ===
        function typeLine(text, callback, speed = 40) {
            let i = 0;
            const line = document.createElement("div");
            terminal.appendChild(line);

            function typing() {
                line.innerHTML += text[i] === "\n" ? "<br>" : text[i];
                i++;
                terminal.scrollTop = terminal.scrollHeight;
                if (i < text.length) {
                    setTimeout(typing, speed);
                } else if (callback) {
                    callback();
                }
            }
            typing();
        }

        // === 新提示符 ===
        function newPrompt() {
            const oldCursor = terminal.querySelector(".cursor");
            if (oldCursor) oldCursor.remove();

            const prompt = document.createElement("div");
            prompt.innerHTML = `C:\\> <span id="input"></span><span class="cursor"></span>`;
            terminal.appendChild(prompt);
            terminal.scrollTop = terminal.scrollHeight;
            terminal.focus();
        }

        // === 命令处理 ===
        function processCommand(cmd) {
            cmd = cmd.trim();
            const inputs = terminal.querySelectorAll("#input");
            const inputEl = inputs[inputs.length - 1];
            if (inputEl) {
                const parent = inputEl.parentNode;
                const cursor = parent.querySelector(".cursor");
                if (cursor) cursor.remove();
                parent.innerHTML = `C:\\> ${cmd}`;
            }

            let output = [];
            const data = getFileData(); // 从 localStorage 获取文件状态

            switch (cmd.toLowerCase()) {
                case "help":
                    const helpText = `
┌──────────────────────────────────────────────┐
│  personal-site:~ user$                      │
└──────────────────────────────────────────────┘

# Welcome to my terminal.
# Available commands:
#   ls <folder>   → list folders and files
#   AboutMe       → learn a bit about me
#   CheatMode     → unlock all files (if you must)
#   Clear         → clean the screen

$ ls
Games   Others

$ ls Games
Pacman   Locked

$ ls Others
Unlocked   Locked

# Some files are locked... for now.
# You *could* use "CheatMode" to unlock everything,
# but where’s the fun in that?
# Play Pacman. Earn your secrets.
`;
                    typeLine(helpText, () => newPrompt(), 20);
                    commandCount++;
                    return;

                case "whoami":
                    output = [
                        "I am a Master’s student at Duke University specializing in game development. My passion lies in games and in exploring innovative interactions as powerful metaphors for storytelling.",
                        "As a Game AI researcher, I study how games can serve as playgrounds for reinforcement learning agents to grow — and, in turn, how those agents can inform and enrich game design and development."
                    ];
                    break;

                case "ls":
                case "ls games":
                case "ls others":
                    const parts = cmd.split(" ");
                    if (parts.length === 1) {
                        output = ["Games   Others"];
                    } else {
                        const folderName = parts[1].charAt(0).toUpperCase() + parts[1].slice(1).toLowerCase();
                        const content = listFolder(folderName);
                        output = [content];
                    }
                    break;

                case "cheatmode":
                    // 一键解锁所有
                    const d = getFileData();
                    Object.keys(d).forEach(folder => {
                        Object.keys(d[folder]).forEach(file => d[folder][file] = true);
                    });
                    localStorage.setItem("terminalData", JSON.stringify(d));
                    output = ["CheatMode activated. All files unlocked."];
                    break;

                case "clear":
                    terminal.innerHTML = "";
                    newPrompt();
                    buffer = "";
                    commandCount = 0;
                    return;

                case "":
                    output = [""];
                    break;

                default:
                    // 检查是否是游戏名
                    const inputName = cmd.toLowerCase();
                    const games = data.Games;

                    const matchedGame = Object.keys(games).find(
                        g => g.toLowerCase() === inputName
                    );

                    if (matchedGame) {
                        if (games[matchedGame]) {
                            output = [`Loading ${matchedGame}.html...`];
                            // 跳转页面
                            window.parent.postMessage(`load-${matchedGame.toLowerCase()}`, "*");
                        } else {
                            output = [`${matchedGame} is still locked. Try unlocking it first.`];
                        }
                    } else {
                        output = [`'${cmd}' is not recognized.`];
                    }
            }

            // 输出文本
            output.forEach(text => {
                const line = document.createElement("div");
                line.textContent = text;
                terminal.appendChild(line);
            });

            commandCount++;
            autoClearIfNeeded();
            newPrompt();
            buffer = "";
        }

        // === 键盘输入 ===
        document.addEventListener("keydown", e => {
            const inputs = terminal.querySelectorAll("#input");
            const inputEl = inputs[inputs.length - 1];
            if (!inputEl) return;

            if (e.key === "Backspace") {
                buffer = buffer.slice(0, -1);
            } else if (e.key === "Enter") {
                processCommand(buffer);
            } else if (e.key.length === 1) {
                buffer += e.key;
            }
            inputEl.textContent = buffer;
        });

        // === 开机闪屏 ===
        function bootSequence() {
            let flashes = 0;
            const interval = setInterval(() => {
                terminal.style.opacity = terminal.style.opacity === "1" ? "0" : "1";
                flashes++;
                if (flashes > 0) {
                    clearInterval(interval);
                    terminal.style.opacity = "1";
                    startTerminal();
                }
            }, 300);
        }

        // === 启动画面 ===
        function startTerminal() {
            typeLine("XINYU_PORTFOLIO v4.0", () => {
                typeLine("\n> Hi. I'm Xinyu, a game developer and Game AI researcher.", () => {
                    typeLine("> Welcome to my cyberspace.", () => {
                        typeLine("\nC:\\> Type 'help' for commands.", () => {
                            newPrompt();
                            terminal.focus();
                        });
                    });
                });
            });
        }

        bootSequence();
    </script>
</body>

</html>